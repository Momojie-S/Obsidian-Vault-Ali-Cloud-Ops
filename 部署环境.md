# 部署环境

服务器部署相关的服务配置和目录结构。

## 服务器初始化（重置后第一步）

> ⚠️ 重要：Homebrew 等工具不允许使用 root 运行，必须先创建普通用户。

### 创建非 root 用户

```bash
# 1. 创建用户（无密码）
/usr/sbin/useradd -m -s /bin/bash momojie

# 2. 复制 SSH 证书（与 root 相同）
mkdir -p /home/momojie/.ssh
cp /root/.ssh/authorized_keys /home/momojie/.ssh/
chown -R momojie:momojie /home/momojie/.ssh
chmod 700 /home/momojie/.ssh
chmod 600 /home/momojie/.ssh/authorized_keys

# 3. 添加 sudo 权限
/usr/sbin/usermod -aG sudo momojie
```

### 验证

```bash
# 确认用户创建成功
id momojie

# 确认 SSH 配置正确
ls -la /home/momojie/.ssh/
```

### SSH 配置

确保 `/etc/ssh/sshd_config` 中禁用密码登录：
```
PasswordAuthentication no
PubkeyAuthentication yes
```

---

## 目录结构

```
/root/env/
├── docker/              # Docker 容器服务
│   ├── clash-conf/      # Clash 代理配置
│   ├── frps/            # FRP 内网穿透配置
│   ├── mysql-conf/      # MySQL 配置
│   ├── docker-compose.yml
│   └── README.md
├── log/                 # 日志目录
│   └── iops_monitor/    # IOPS 监控日志
├── iops_monitor.sh      # 磁盘 IOPS 监控脚本
└── .claude/             # Claude AI 配置
```

---

## Docker 服务

位置：`/root/env/docker/`

### docker-compose.yml

```yaml
services:
  mysql:
    image: mysql:8.0
    container_name: mysql-dev
    environment:
      MYSQL_ROOT_PASSWORD: LoveYebao0924.
      MYSQL_DATABASE: devdb
      MYSQL_USER: devuser
      MYSQL_PASSWORD: LoveYebao0924.
    ports:
      - "21001:3306"
    volumes:
      # 使用额外的磁盘空间来存储 MySQL 数据
      - /mnt/mysql-data:/var/lib/mysql
      # 可选：挂载配置文件
      - ./mysql-conf:/etc/mysql/conf.d:ro
    restart: unless-stopped
    networks:
      - dev-network

  frps:
    image: stilleshan/frps:latest
    container_name: frps
    restart: unless-stopped
    ports:
      - "22001:22001"  # frp 服务端口
      - "22002:22002"  # SSH 映射端口（可按需添加更多端口）
    volumes:
      - ./frps/frps.ini:/frp/frps.ini:ro
    networks:
      - dev-network

  clash:
    image: dreamacro/clash
    container_name: clash
    network_mode: "host"  # 共享主机网络栈
    restart: unless-stopped
    volumes:
      - ./clash-conf/config.yml:/root/.config/clash/config.yaml:ro

networks:
  dev-network:
    driver: bridge
```

### 服务列表

| 服务 | 容器名 | 端口 | 用途 |
|------|--------|------|------|
| MySQL | mysql-dev | 21001:3306 | 开发数据库 |
| FRPS | frps | 22001, 22002 | 内网穿透服务端 |
| Clash | clash | host 模式 | 代理服务 |

### MySQL

- **镜像**: `mysql:8.0`
- **端口**: 21001（外部）→ 3306（内部）
- **数据目录**: `/mnt/mysql-data`
- **配置目录**: `./mysql-conf/`
- **默认数据库**: devdb

#### MySQL 配置 (my.cnf)

```ini
[mysqld]
# 设置字符集
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 设置时区
default-time-zone = '+8:00'

# 性能相关配置
innodb_buffer_pool_size = 256M
innodb_log_file_size = 64M
max_connections = 200

# 安全设置
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
```

### FRPS

- **镜像**: `stilleshan/frps:latest`
- **配置文件**: `./frps/frps.ini`
- **服务端口**: 22001
- **SSH 映射端口**: 22002

#### FRPS 配置 (frps.ini)

```ini
[common]
# frp 服务端口
bind_port = 22001

# 认证令牌
authentication_method = token
token = LoveYebao0924.

# 心跳超时（秒）- 应大于客户端的 heartbeat_timeout（90秒）
heartbeat_timeout = 120

# TCP 多路复用 - 开启可减少连接数，提高性能
tcp_mux = true

# 每个代理的最大连接池大小
max_pool_count = 10

# 客户端连接超时（秒）
user_conn_timeout = 10

# 日志配置
log_file = /dev/stdout
log_level = info
log_max_days = 3
```

### Clash

- **镜像**: `dreamacro/clash`
- **网络模式**: host（共享主机网络栈）
- **配置文件**: `./clash-conf/config.yml`

> Clash 配置文件较大，包含代理节点信息，直接查看源文件：`/root/env/docker/clash-conf/config.yml`

### 常用命令

```bash
# 进入目录
cd /root/env/docker

# 启动所有服务
docker compose up -d

# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f mysql

# 重启服务
docker compose restart <服务名>
```

---

## IOPS 监控脚本

位置：`/root/env/iops_monitor.sh`

### 功能

- 实时监控磁盘 IOPS
- 当 IOPS 超过阈值（默认 1000）时自动记录系统状态
- 记录高 IO 进程、系统负载、内存使用等信息

### 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| SAMPLE_INTERVAL | 2s | 采样间隔 |
| SPIKE_THRESHOLD | 1000 | IOPS 飙升阈值 |
| SPIKE_COUNT | 3 | 连续触发次数 |
| CALM_WINDOW | 30s | 触发后冷静期 |

### 日志位置

- 主日志：`/root/env/log/iops_monitor/iops_spike.log`
- 详细日志：`/root/env/log/iops_monitor/spike_*.log`

### 运行

```bash
# 前台运行
/root/env/iops_monitor.sh

# 后台运行
nohup /root/env/iops_monitor.sh > /dev/null 2>&1 &
```

---

## 相关链接

- [[OpenClaw 部署]] - OpenClaw 服务部署笔记
