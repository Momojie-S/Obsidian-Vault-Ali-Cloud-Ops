# 部署环境

服务器部署相关的服务配置和目录结构。

## 目录结构

```
/root/env/
├── docker/              # Docker 容器服务
│   ├── clash-conf/      # Clash 代理配置
│   ├── frps/            # FRP 内网穿透配置
│   ├── mysql-conf/      # MySQL 配置
│   ├── docker-compose.yml
│   └── README.md
├── log/                 # 日志目录
│   └── iops_monitor/    # IOPS 监控日志
├── iops_monitor.sh      # 磁盘 IOPS 监控脚本
└── .claude/             # Claude AI 配置
```

---

## Docker 服务

位置：`/root/env/docker/`

### 服务列表

| 服务 | 容器名 | 端口 | 用途 |
|------|--------|------|------|
| MySQL | mysql-dev | 21001:3306 | 开发数据库 |
| FRPS | frps | 22001, 22002 | 内网穿透服务端 |
| Clash | clash | host 模式 | 代理服务 |

### MySQL

- **镜像**: `mysql:8.0`
- **端口**: 21001（外部）→ 3306（内部）
- **数据目录**: `/mnt/mysql-data`
- **配置目录**: `./mysql-conf/`
- **默认数据库**: devdb

### FRPS

- **镜像**: `stilleshan/frps:latest`
- **配置文件**: `./frps/frps.ini`
- **服务端口**: 22001
- **SSH 映射端口**: 22002

### Clash

- **镜像**: `dreamacro/clash`
- **网络模式**: host（共享主机网络栈）
- **配置文件**: `./clash-conf/config.yml`

### 常用命令

```bash
# 进入目录
cd /root/env/docker

# 启动所有服务
docker compose up -d

# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f mysql

# 重启服务
docker compose restart <服务名>
```

---

## IOPS 监控脚本

位置：`/root/env/iops_monitor.sh`

### 功能

- 实时监控磁盘 IOPS
- 当 IOPS 超过阈值（默认 1000）时自动记录系统状态
- 记录高 IO 进程、系统负载、内存使用等信息

### 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| SAMPLE_INTERVAL | 2s | 采样间隔 |
| SPIKE_THRESHOLD | 1000 | IOPS 飙升阈值 |
| SPIKE_COUNT | 3 | 连续触发次数 |
| CALM_WINDOW | 30s | 触发后冷静期 |

### 日志位置

- 主日志：`/root/env/log/iops_monitor/iops_spike.log`
- 详细日志：`/root/env/log/iops_monitor/spike_*.log`

### 运行

```bash
# 前台运行
/root/env/iops_monitor.sh

# 后台运行
nohup /root/env/iops_monitor.sh > /dev/null 2>&1 &
```

---

## 相关链接

- [[OpenClaw 部署]] - OpenClaw 服务部署笔记
